name: JFrog CI Workflow

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    permissions:
      id-token: write
      contents: read

    runs-on: ubuntu-latest

    env:
      JFROG_URL: "https://andrewrjpd1.jfrog.io"
      JFROG_OIDC_PROVIDER_NAME: "github"
      JFROG_OIDC_AUDIENCE: "jfrog"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Use v4 of the action and force it to install the LATEST CLI version
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest # This is the key change

      # 2. Add the explicit server configuration step (this will now work)
      - name: Configure JFrog Server
        run: |
          jf c add temp-server --url=$JFROG_URL --oidc-provider-name=$JFROG_OIDC_PROVIDER_NAME --oidc-audience=$JFROG_OIDC_AUDIENCE
          jf c use temp-server

      # 3. Debug step to verify
      - name: Show JFrog CLI Config
        run: jf c show

      # 4. Upload the artifact
      - name: Upload Artifact to Artifactory
        run: |
          echo "Hello from GitHub Actions!" > my-file.txt
          jf rt u "my-file.txt" "my-generic-repo/"
          echo "Upload complete!"
